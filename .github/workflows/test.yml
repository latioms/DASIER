name: Build My Docker Flask App
on: [push, merge]
jobs:

  build:
    name: Build
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
  
      - name: Stop and remove existing container
        run: |
          docker stop dasier-run || true
          docker rm dasier-run || true

      - name: Build the Docker image
        run: docker build . --file Dockerfile --tag dasier:latest
          
      - name: Build and run
        run: |
          docker run -d --name dasier-run -p 5000:5000 dasier:latest

  notify:
    - name: 'Sending SMS Notification'
      uses: twilio-labs/actions-sms@v1
      with:
        fromPhoneNumber: ${{ secrets.TWILIO_PHONE_NUMBER }}
        toPhoneNumber: ${{ secrets.MY_PHONE_NUMBER }}
        message: |
          Something has been shipped ðŸŽ‰
          ðŸ“Œ ${{ github.actor }} made a commit to ${{ github.repository }}.
      env:
        TWILIO_MESSAGING_SERVICE_SID: ${{ secrets.TWILIO_MESSAGING_SERVICE_SID }}
        TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
        TWILIO_API_KEY: ${{ secrets.TWILIO_API_KEY }}
        TWILIO_API_SECRET: ${{ secrets.TWILIO_API_SECRET }}